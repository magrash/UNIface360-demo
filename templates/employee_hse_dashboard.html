<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Employee HSE Performance Dashboard</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Shared site dashboard styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}" />
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
    <!-- DataTables (Bootstrap 5) -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet" />

    <style>
        :root {
            --brand-green: var(--primary, #22d3ee);
            --bg-light: var(--bg, #0f172a);
            --text-dark: var(--text, #e2e8f0);
            --card-bg: var(--card, rgba(255,255,255,0.06));
            --card-border: var(--card-border, rgba(255,255,255,0.12));
        }

        /* use shared dashboard.css variables; body class toggled via .light-theme */
        body { background: var(--bg); color: var(--text); }

        .navbar { background: transparent; border-bottom: 1px solid var(--card-border); }

        .brand-badge {
            background: var(--brand-green);
            color: #fff;
            font-weight: 700;
            padding: 6px 10px;
            border-radius: 8px;
        }

        .card.custom-card { background: var(--card-bg); border: 1px solid var(--card-border) !important; }
        .kpi-icon {
            width: 44px; height: 44px; display: inline-flex; align-items: center; justify-content: center;
            border-radius: 10px; background: rgba(0, 152, 121, 0.12); color: var(--brand-green);
        }
        .trend-up { color: #16a34a; }
        .trend-down { color: #dc2626; }

        /* Chart containers */
        .chart-card { height: 360px; }
        .chart-card canvas { height: 300px !important; }

        footer { border-top: 1px solid var(--card-border); color: var(--muted, #94a3b8); }
        .avatar { width: 34px; height: 34px; border-radius: 50%; object-fit: cover; }
    </style>
</head>
<body class="dashboard">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center gap-2" href="{{ url_for('employee_hse_dashboard') }}">
                <span class="brand-badge">HSE</span>
                <span class="fw-semibold">Performance Dashboard</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNav" aria-controls="topNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="topNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item me-3">
                        <button class="btn btn-success" id="btnSubmitReport"><i class="fa-solid fa-plus me-1"></i>Submit New Report</button>
                    </li>
                    <li class="nav-item me-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="themeToggle">
                            <label class="form-check-label" for="themeToggle">Light/Dark</label>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center gap-2" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <img src="https://i.pravatar.cc/100?img=5" alt="avatar" class="avatar" />
                            <span class="fw-semibold">Employee</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#">Profile</a></li>
                            <li><a class="dropdown-item" href="#">My Reports</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('logout') }}">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid p-0">
        <div class="row g-0">
            <!-- Sidebar (matches HSE style) -->
            <aside class="col-12 col-lg-2 sidebar p-3">
                <h6 class="text-uppercase text-muted px-2">Navigation</h6>
                <ul class="nav nav-pills flex-column gap-1 mt-2">
                    <li class="nav-item"><a class="nav-link active d-flex align-items-center gap-2" href="{{ url_for('employee_hse_dashboard') }}"><i class="fa-solid fa-gauge"></i> Dashboard Overview</a></li>
                    <li class="nav-item"><a class="nav-link d-flex align-items-center gap-2" href="#reports"><i class="fa-regular fa-file-lines"></i> My Reports</a></li>
                    <li class="nav-item"><a class="nav-link d-flex align-items-center gap-2" href="#trainings"><i class="fa-solid fa-chalkboard-user"></i> Trainings</a></li>
                </ul>
            </aside>

            <!-- Main Content -->
            <main class="col-12 col-lg-10 p-3 p-lg-4">
        <!-- KPI Cards -->
        <div class="row g-3 mb-2">
            <div class="col-12 col-sm-6 col-xl-3">
                <div class="card custom-card shadow-sm rounded-3 p-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="kpi-icon"><i class="fa-solid fa-helmet-safety"></i></div>
                        <div class="text-end">
                            <div class="small text-muted">Total Incidents</div>
                            <div class="h4 mb-0" id="kpiIncidents">0</div>
                            <div class="small"><span id="trendIncidents" class="trend-up">↑</span> vs last month</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-xl-3">
                <div class="card custom-card shadow-sm rounded-3 p-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="kpi-icon"><i class="fa-solid fa-user-injured"></i></div>
                        <div class="text-end">
                            <div class="small text-muted">Lost Time Injuries (LTI)</div>
                            <div class="h4 mb-0" id="kpiLti">0</div>
                            <div class="small"><span id="trendLti" class="trend-down">↓</span> vs last month</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-xl-3">
                <div class="card custom-card shadow-sm rounded-3 p-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="kpi-icon"><i class="fa-solid fa-exclamation-triangle"></i></div>
                        <div class="text-end">
                            <div class="small text-muted">Near Miss Reports</div>
                            <div class="h4 mb-0" id="kpiNearMiss">0</div>
                            <div class="small"><span id="trendNearMiss" class="trend-up">↑</span> vs last month</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-xl-3">
                <div class="card custom-card shadow-sm rounded-3 p-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="kpi-icon"><i class="fa-solid fa-chalkboard-user"></i></div>
                        <div class="text-end">
                            <div class="small text-muted">Safety Trainings</div>
                            <div class="h4 mb-0" id="kpiTrainings">0</div>
                            <div class="small"><span id="trendTrainings" class="trend-up">↑</span> completion</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row g-3 mb-3">
            <div class="col-12 col-xl-6">
                <div class="card custom-card shadow-sm rounded-3 p-3 chart-card">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Incident Rate per Month</h6>
                        <i class="fa-solid fa-chart-line text-success"></i>
                    </div>
                    <canvas id="lineIncident"></canvas>
                </div>
            </div>
            <div class="col-12 col-xl-6">
                <div class="card custom-card shadow-sm rounded-3 p-3 chart-card">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Incidents by Department</h6>
                        <i class="fa-solid fa-chart-column text-success"></i>
                    </div>
                    <canvas id="barDept"></canvas>
                </div>
            </div>
            <div class="col-12 col-xl-6">
                <div class="card custom-card shadow-sm rounded-3 p-3 chart-card">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Severity Distribution</h6>
                        <i class="fa-solid fa-circle-half-stroke text-success"></i>
                    </div>
                    <canvas id="pieSeverity"></canvas>
                </div>
            </div>
            <div class="col-12 col-xl-6">
                <div class="card custom-card shadow-sm rounded-3 p-3 chart-card">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Training Completion</h6>
                        <i class="fa-solid fa-chart-area text-success"></i>
                    </div>
                    <canvas id="doughnutTraining"></canvas>
                </div>
            </div>
        </div>

        <!-- Trainings Section -->
        <div id="trainings" class="card custom-card shadow-sm rounded-3 p-3 mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0"><i class="fa-solid fa-graduation-cap me-2 text-success"></i>My Safety Trainings</h6>
                <button class="btn btn-sm btn-outline-success"><i class="fa-solid fa-rotate me-1"></i>Refresh</button>
            </div>
            <div class="row g-3">
                <div class="col-12 col-md-6">
                    <div class="small mb-1">Fire Safety Basics</div>
                    <div class="progress" role="progressbar" aria-label="Fire Safety" aria-valuenow="85" aria-valuemin="0" aria-valuemax="100">
                        <div class="progress-bar bg-success" style="width: 85%">85%</div>
                    </div>
                </div>
                <div class="col-12 col-md-6">
                    <div class="small mb-1">PPE Compliance</div>
                    <div class="progress" role="progressbar" aria-label="PPE" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100">
                        <div class="progress-bar bg-success" style="width: 60%">60%</div>
                    </div>
                </div>
                <div class="col-12 col-md-6">
                    <div class="small mb-1">Emergency Response</div>
                    <div class="progress" role="progressbar" aria-label="Emergency" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100">
                        <div class="progress-bar bg-success" style="width: 45%">45%</div>
                    </div>
                </div>
                <div class="col-12 col-md-6">
                    <div class="small mb-1">Hazard Communication</div>
                    <div class="progress" role="progressbar" aria-label="Hazards" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">
                        <div class="progress-bar bg-success" style="width: 100%">100%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="card custom-card shadow-sm rounded-3 p-3" id="reports">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Recent HSE Reports</h6>
            </div>
            <div class="table-responsive">
                <table id="reportsTable" class="table table-striped" style="width:100%">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Department</th>
                            <th>Type</th>
                            <th>Severity</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-4 py-3 text-center small">
            © {{ current_year }} HSE Dashboard — All Rights Reserved
        </footer>
            </main>
        </div>
    </div>

    <!-- JS libs -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
        // Dummy Data (shared with admin)
        const kpis = {
            incidents: 25,
            lti: 2,
            nearMiss: 6,
            trainings: 40,
        };

        const incidentTrend = ['Jan','Feb','Mar','Apr','May','Jun'];
        const incidentValues = [3,5,4,6,2,5];

        const deptData = {
            labels: ['Operations','Maintenance','Logistics','Drilling'],
            values: [8,5,4,6]
        };

        const severityData = {
            labels: ['Minor','Major','Critical'],
            values: [12,8,5]
        };

        const reports = [
            { date: '2025-06-03', dept: 'Operations', type: 'Incident', severity: 'Major', status: 'Open' },
            { date: '2025-06-02', dept: 'Maintenance', type: 'Near Miss', severity: 'Minor', status: 'Closed' },
            { date: '2025-06-01', dept: 'Logistics', type: 'LTI', severity: 'Critical', status: 'In Review' },
            { date: '2025-05-30', dept: 'Drilling', type: 'Incident', severity: 'Minor', status: 'Open' },
            { date: '2025-05-29', dept: 'Operations', type: 'Near Miss', severity: 'Major', status: 'Closed' },
            { date: '2025-05-28', dept: 'Maintenance', type: 'Incident', severity: 'Minor', status: 'Open' },
            { date: '2025-05-27', dept: 'Logistics', type: 'Incident', severity: 'Major', status: 'In Review' },
            { date: '2025-05-26', dept: 'Drilling', type: 'Near Miss', severity: 'Minor', status: 'Closed' },
        ];

        // Theme helpers
        const brandGreen = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#009879';

        function setTheme(light) {
            if (light) {
                document.body.classList.add('light-theme');
                document.documentElement.setAttribute('data-bs-theme', 'light');
            } else {
                document.body.classList.remove('light-theme');
                document.documentElement.setAttribute('data-bs-theme', 'dark');
            }
            const textColor = getComputedStyle(document.body).getPropertyValue('--text').trim() || '#e2e8f0';
            [lineChart, barChart, pieChart, doughnutChart].forEach(ch => {
                if (!ch) return;
                ch.options.scales && Object.values(ch.options.scales).forEach(scale => {
                    scale.ticks = scale.ticks || {}; scale.grid = scale.grid || {};
                    scale.ticks.color = textColor;
                    scale.grid.color = 'rgba(125,125,125,0.15)';
                });
                ch.options.plugins.legend.labels.color = textColor;
                ch.update();
            });
        }

        // KPIs
        function renderKpis() {
            document.getElementById('kpiIncidents').textContent = kpis.incidents;
            document.getElementById('kpiLti').textContent = kpis.lti;
            document.getElementById('kpiNearMiss').textContent = kpis.nearMiss;
            document.getElementById('kpiTrainings').textContent = kpis.trainings;
        }

        // Charts
        let lineChart, barChart, pieChart, doughnutChart;
        function createCharts() {
            const textColor = getComputedStyle(document.body).getPropertyValue('--text').trim() || '#e2e8f0';
            lineChart = new Chart(document.getElementById('lineIncident'), {
                type: 'line',
                data: {
                    labels: incidentTrend,
                    datasets: [{
                        label: 'Incidents',
                        data: incidentValues,
                        borderColor: brandGreen,
                        backgroundColor: 'rgba(0,152,121,0.15)',
                        fill: true,
                        tension: 0.35,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: textColor } } },
                    scales: {
                        x: { ticks: { color: textColor }, grid: { color: 'rgba(125,125,125,0.15)' } },
                        y: { ticks: { color: textColor }, grid: { color: 'rgba(125,125,125,0.15)' } }
                    }
                }
            });

            barChart = new Chart(document.getElementById('barDept'), {
                type: 'bar',
                data: { labels: deptData.labels, datasets: [{ label: 'Incidents', data: deptData.values, backgroundColor: 'rgba(0,152,121,0.7)', borderRadius: 8 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: textColor } } },
                    scales: { x: { ticks: { color: textColor }, grid: { display: false } }, y: { ticks: { color: textColor }, grid: { color: 'rgba(125,125,125,0.15)' } } }
                }
            });

            pieChart = new Chart(document.getElementById('pieSeverity'), {
                type: 'pie',
                data: { labels: severityData.labels, datasets: [{ data: severityData.values, backgroundColor: ['#10b981', '#f59e0b', '#ef4444'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: textColor } } } }
            });

            const completed = 72;
            doughnutChart = new Chart(document.getElementById('doughnutTraining'), {
                type: 'doughnut',
                data: { labels: ['Completed', 'Pending'], datasets: [{ data: [completed, 100 - completed], backgroundColor: [brandGreen, '#e5e7eb'] }] },
                options: { cutout: '70%', responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: textColor } } } }
            });
        }

        // Table
        function renderTable() {
            const tbody = document.querySelector('#reportsTable tbody');
            tbody.innerHTML = '';
            reports.slice(0, 8).forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${r.date}</td>
                    <td>${r.dept}</td>
                    <td>${r.type}</td>
                    <td>${r.severity}</td>
                    <td><span class="badge ${r.status === 'Open' ? 'text-bg-warning' : r.status === 'Closed' ? 'text-bg-success' : 'text-bg-info'}">${r.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-secondary"><i class="fa-regular fa-eye"></i></button>
                    </td>`;
                tbody.appendChild(tr);
            });
            const dt = new DataTable('#reportsTable', { order: [[0, 'desc']], pageLength: 6 });
        }

        // Events
        document.addEventListener('DOMContentLoaded', () => {
            setTheme(false);
            document.getElementById('themeToggle').addEventListener('change', (e) => setTheme(e.target.checked));
            document.getElementById('btnSubmitReport').addEventListener('click', () => {
                alert('Open report submission modal/form (to be integrated).');
            });

            renderKpis();
            createCharts();
            renderTable();
        });
    </script>
</body>
</html>


